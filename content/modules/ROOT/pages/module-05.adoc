= Dynamic Rescheduling of Workloads


You can use the descheduler to evict pods based on specific strategies so that the pods can be rescheduled onto more appropriate nodes.

You can benefit from descheduling running pods in situations such as the following:

* Nodes are underutilized or overutilized.
* Pod and node affinity requirements, such as taints or labels, have changed and the original scheduling decisions are no longer appropriate for certain nodes.
* Node failure requires pods to be moved.
* New nodes are added to clusters.
* Pods have been restarted too many times.

== Objectives

In this module, we will guide you through the process of configuring Rescheduling Strategies with these profiles:

* LifecycleAndUtilization - LowNodeUtilization
  ** finds nodes that are underutilized and evicts pods, if possible, from overutilized nodes in the hope that recreation of evicted pods will be scheduled on these underutilized nodes.
  *** A node is considered underutilized if its usage is below 20% for all thresholds (CPU, memory, and number of pods).
  *** A node is considered overutilized if its usage is above 50% for any of the thresholds (CPU, memory, and number of pods).

* KubeVirtRelieveAndMigrate
  ** evicts pods from high-cost nodes to reduce overall resource expenses and enable workload migration. It also periodically rebalances workloads to help maintain similar spare capacity across nodes, which supports better handling of sudden workload spikes. Nodes can experience the following costs:

  *** Resource utilization: Increased resource pressure raises the overhead for running applications.
  *** Node maintenance: A higher number of containers on a node increases resource consumption and maintenance costs.

== Requirements

* Descheduler Operator must be installed
* The `KubeVirtRelieveAndMigrate` profile requires PSI metrics to be enabled on all worker nodes. For your convenience, this is already enabled in this lab.

== Instructions

=== 1. Access the LAB
1.1 Log in to the OpenShift cluster as the <admin> user with <password> as the password


[source,sh,role=execute]
----
oc login -u admin -p redhatocp https://api.ocp4.example.com:6443
----
1.2 Identify the URL for the OpenShift web console


[source,sh,role=execute]
----
oc whoami --show-console
----

1.3. Open a web browser and go to https://console-openshift-console.apps.ocp4.example.com. Click htpasswd_provider and log in as the <admin> user with <password> as the password



== 2. Check which virtual machines are running in the `dynamic-schedule` namespace

[source,sh,role=execute]
----
oc get vmi -n dynamic-schedule
----

You should see the following output:

[source,sh,role=execute]
----
NAME     AGE     PHASE     IP             NODENAME
dynamic-schedule-vm1    10m     Running   10.129.2.111   worker01
dynamic-schedule-vm2    10m     Running   10.129.2.112   worker02
----

Or using the OpenShift Virtualization console, you can see the VMs in the `dynamic-schedule` namespace.

image::exercise5/05-image-vm-list.png[title="VM List", link=self, window=blank, width=100%]

== 3. Configure the Descheduler Operator

[source,sh,role=execute]
----
oc edit descheduler dynamic-schedule
----

You should see the following output:

[source,yaml]
----
apiVersion: operator.openshift.io/v1
kind: KubeDescheduler
metadata:
  name: cluster
  namespace: openshift-kube-descheduler-operator
spec:
  logLevel: Normal
  mode: Predictive
  operatorLogLevel: Normal
  profileCustomizations:
    devDeviationThresholds: AsymmetricLow
  profiles:
    - LifecycleAndUtilization
    - KubeVirtRelieveAndMigrate
  deschedulingIntervalSeconds: 3600
  managementState: Managed    
----

NOTE: Notice the mode is set to Predictive. By default, the descheduler does not evict pods. To evict pods, set mode to Automatic.

